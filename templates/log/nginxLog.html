{#{% extends 'home/index.html' %}#}
{% load staticfiles %}
{#{% block content %}#}
{#    <div class="page_container">#}
{#        <div class="page_title">nginx日志</div>#}
{#        <div class="page_hr"></div>#}
{#        <div id="container" tabindex="0"></div>#}
{#            <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=d1808236607dc77b1171b39494a3ae82"></script>#}
{#            <script type="text/javascript">#}
{#                var map = new AMap.Map('container',{#}
{#                    resizeEnable: true,#}
{#                    zoom: 10,#}
{#                    center: [116.480983, 40.0958]#}
{#                });#}
{#            </script>#}
{#    </div>#}
{#{% endblock %}#}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
    <title>点聚合</title>
    <link rel="stylesheet" href="{% static 'log/css/nginxLog.css' %}">
    <script src="{% static 'bootstrap/js/jquery-min.js' %}"></script>
    <script src="{% static 'log/js/geohash.js' %}"></script>
    <script src="http://webapi.amap.com/maps?v=1.3&key=d1808236607dc77b1171b39494a3ae82&plugin=AMap.MarkerClusterer"></script>
</head>
<body>
<div id="container"></div>
<script>
    var cluster, markers = [];
    var map = new AMap.Map("container", {
        resizeEnable: true,
        zoom: 4,
        mapStyle:"amap://styles/eb7e0c164f54d395c1a66b7db4041173"
    });
    //返回相匹配点的数量
    function retDocument(loca,docCount,point) {
        for (var i =0;i<loca.length;i++){
            if(parseInt(loca[i][0])==parseInt(point[0]) && parseInt(loca[i][1])==parseInt(point[1])){
                break;
            }
        }
        return docCount[i]
    }
    //选择样式
    function selectStyle(maxNum,curNum) {
        var styleName='makerL1'
       if(curNum/maxNum>=0.9){
           styleName='makerL5'
       }else if(curNum/maxNum>=0.7){
           styleName='makerL4'
       }
       else if(curNum/maxNum>=0.5){
           styleName='makerL3'
       }
       else if(curNum/maxNum>=0.3){
           styleName='makerL2'
       }
       return styleName
    }
    $.get('http://127.0.0.1:8000/api/nginxLog',function (data) {
        var location=[]
        var docCount=[]
        for (var i=0;i<data.length;i++){
            location.push([decodeGeoHash(data[i]['key'])['longitude'][2],decodeGeoHash(data[i]['key'])['latitude'][2]])
            docCount.push(data[i]['doc_count'])
        }
        var maxNum=Math.max.apply(null,docCount)
        for(var i=0;i<location.length;i++){
            markers.push(new AMap.Marker({
                map:map,
                position:location[i],
                content: '<div class="'+selectStyle(maxNum,docCount[i])+'"></div>',
                offset: new AMap.Pixel(0,0)
        }))
            AMap.event.addListener(markers[i], 'click', function(context) {
                point=[context.target.getPosition().lng,context.target.getPosition().lat]
                var docNum=retDocument(location,docCount,point)
                var infoWindow = new AMap.InfoWindow({
                    isCustom: true,
                    content: '<div style="background-color:red: 20px; width: 20px;font-size:12px;">'+docNum+'</div>',
                    offset: new AMap.Pixel(0, 0)
                });
                infoWindow.open(map,context.lnglat)
        });
        }
    })
</script>
</body>
</html>